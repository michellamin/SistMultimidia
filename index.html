<!DOCTYPE html>
<html>
<head>
<meta charset="US-ASCII">
<meta http-equiv="cache-control" content="no-cache" />
<title>JPEG Encoder</title>

</head>
<body>
<div id="slidecontainer">
  <input type="range" min="1" max="100" value="50" class="slider" id="slideId">
  <p>Quality: <span id="displayQuality"></span>%</p>
</div>
<div id="amount" style="font-weight: bold; font-size: 1em;">
	<input type="file" name="fileToUpload" id="fileToUpload" onchange='readfile(this.files[0])'>
</div>
<div><input type="button" onclick="startEncoding();" value="Encode"></div>
<div>
	<img id="img" src="img/sample_shard.png" />
	<img id="imgY" src="img/sample_shard.png" />
	<img id="imgCr" src="img/sample_shard.png" />
	<img id="imgCb" src="img/sample_shard.png" />
	<img id="imgResult" src="img/sample_shard.png" />
</div>

<script src="pttjpeg.js" type="text/javascript" charset="utf-8"></script>

<style type="text/css">
	
#slidecontainer {
    width: 100%; /* Width of the outside container */
}

.slider {
    -webkit-appearance: none;
    width: 100%;
    height: 15px;
    border-radius: 5px;   
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%; 
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
}
</style>

<script>
	var origImageData;//variavel global da imagem Original
	var resetSlide;//variavel de controle 

	function getPixelsFromImageElement(imgElem) {
        var canvas = document.createElement("canvas");
        canvas.width = imgElem.clientWidth;
        canvas.height = imgElem.clientHeight;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(imgElem, 0, 0);
        return ctx.getImageData(0,0,canvas.width,canvas.height);
    }

    //Lê uma nova imagem
    function readfile(f) {
	    var reader = new FileReader();
	    reader.readAsDataURL(f);
	    reader.onload = function() {
	        origUrl = reader.result;
	        var out = document.getElementById("img");
	        out.style.width = "";
	        out.setAttribute('src', origUrl );
	        out.onload = function() {
	            origImageData = getPixelsFromImageElement(out);
	            encode(50);
	            resetSlide = true;
	            reset(50);
	        }
    	}
    	reader.onerror = function(e) { // If anything goes wrong
        	console.log("Error", e); // Just log it
    	};
    }

    //Extrair a luminancia Y
    var extractY = function(){
			var encoder = new pttJPEG();
	    	var v = encoder.version();
	    	console.log(v);
	    	var imgElem = document.getElementById("img");;
		    var origImageData = new encoder.pttImage( getPixelsFromImageElement(imgElem));
		    var bw = new encoder.ByteWriter();
		    var type = 1; //tipo de imagem output
		    encoder.encodeSubSample(origImageData, bw,type);
		    var url = bw.getImgUrl();

		    var dstImgElem = document.getElementById("imgY");
		    dstImgElem.setAttribute("src", url);
	}

	//Extrair crominância Cr
    var extractCr = function(){
			var encoder = new pttJPEG();
	    	var v = encoder.version();
	    	console.log(v);
	    	var imgElem = document.getElementById("img");;
		    var origImageData = new encoder.pttImage( getPixelsFromImageElement(imgElem));
		    var bw = new encoder.ByteWriter();
		    var type = 2; //tipo de imagem output
		    encoder.encodeSubSample(origImageData, bw,type);
		    var url = bw.getImgUrl();

		    var dstImgElem = document.getElementById("imgCr");
		    dstImgElem.setAttribute("src", url);
	}

	//Extrair crominância Cb
    var extractCb = function(){
			var encoder = new pttJPEG();
	    	var v = encoder.version();
	    	console.log(v);
	    	var imgElem = document.getElementById("img");;
		    var origImageData = new encoder.pttImage( getPixelsFromImageElement(imgElem));
		    var bw = new encoder.ByteWriter();
		    var type = 3; //tipo de imagem output
		    encoder.encodeSubSample(origImageData, bw,type);
		    var url = bw.getImgUrl();

		    var dstImgElem = document.getElementById("imgCb");
		    dstImgElem.setAttribute("src", url);
	}

	//Faz o encoding a partir da qualidade do slider
    var encode = function(value){
			var encoder = new pttJPEG();
	    	var v = encoder.version();
	    	console.log(v);
	    	var imgElem = document.getElementById("img");;
		    var origImageData = new encoder.pttImage( getPixelsFromImageElement(imgElem));
		    var bw = new encoder.ByteWriter();
		    encoder.encode(value,origImageData,bw);
		    var url = bw.getImgUrl();

		    var dstImgElem = document.getElementById("imgResult");
		    dstImgElem.setAttribute("src", url);
	}

	//Reseta o valor do Slider para um valor inicial
	var reset = function(value){
		if(resetSlide){
			var slider = document.getElementById("slideId");
			var output = document.getElementById("displayQuality");
			slider.value = value;
    		output.innerHTML = slider.value;
    		resetSlide = false;
    	}	
	}

    window.onload = function() {
	    /**
	     * Returns an ImageData object 
	     * @param imgElem
	     */
	 	var slider = document.getElementById("slideId");
		var output = document.getElementById("displayQuality");
		output.innerHTML = slider.value; 
		slider.oninput = function() {
	    	output.innerHTML = this.value;
			encode(parseInt(this.value))
		}	
		extractY();
		extractCr()
		extractCb();
    }
</script>
</body>
</html>
